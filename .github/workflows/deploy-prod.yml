name: Deploy to EC2 (main auto)

on:
  push:
    branches: [ "main" ]

concurrency:
  group: deploy-to-ec2
  cancel-in-progress: false  # ì´ì „ ë°°í¬ê°€ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ê²Œ í•¨

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v3

      - name: Deploy to EC2 via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_KEY }}
          timeout: 15m
          script: |
            echo "ðŸ“Œ JAVA_HOME ì„¤ì • (Java 21)"
            export JAVA_HOME=/usr/lib/jvm/java-21-openjdk-amd64
            export PATH=$JAVA_HOME/bin:$PATH
            
            echo "ðŸ“ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ë¡œ ì´ë™"
            cd ~/WEB4_5_AnjolinaJelly_BE
            git checkout main
            git pull origin main

            echo "ðŸ’£ ì‹¤í–‰ ì¤‘ì¸ JAR ì¢…ë£Œ"
            # ì‹¤í–‰ ì¤‘ì¸ ìŠ¤í”„ë§ ì•± PID ì°¾ì•„ì„œ ì¢…ë£Œ (í”„ë¡œì„¸ìŠ¤ê°€ ì—†ëŠ” ê²½ìš° ì—ëŸ¬ ë°©ì§€)
            ps aux | grep 'zzirit-0.0.1-SNAPSHOT.jar' | grep -v grep | awk '{print $2}' | xargs -r kill -9

            echo "ðŸ§¹ ì´ì „ ë¹Œë“œ ê²°ê³¼ ì •ë¦¬"
            ./gradlew clean || rm -rf build/

            echo "âš™ï¸ Nginx, Docker ì»¨í…Œì´ë„ˆ ì‹¤í–‰"
            cd ~
            sudo systemctl stop nginx || true
            docker-compose -f docker-compose.nginx.yaml up -d

            cd ~/WEB4_5_AnjolinaJelly_BE
            docker-compose -f docker-compose.dev.yaml up -d

            echo "ðŸ› ï¸ ì• í”Œë¦¬ì¼€ì´ì…˜ ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸)"
            ./gradlew build -x test

            echo "ðŸ”— application-secret.yml ì‹¬ë³¼ë¦­ ë§í¬ ìƒì„±"
            ln -sf ../../src/main/resources/application-secret.yml ./build/libs/

            echo "ðŸš¨ JAR ìš©ëŸ‰ í™•ì¸"
            FILE=./build/libs/zzirit-0.0.1-SNAPSHOT.jar
            MAX_SIZE=200000000  # 200MB
            ACTUAL_SIZE=$(stat -c%s "$FILE")
            if [ "$ACTUAL_SIZE" -gt "$MAX_SIZE" ]; then
              echo "âŒ JAR íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤ (${ACTUAL_SIZE} bytes). ì‚­ì œí•©ë‹ˆë‹¤."
              rm -f "$FILE"
              exit 1
            fi

            echo "ðŸš€ Spring Boot ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹¤í–‰"
            cd ./build/libs
            nohup java -jar zzirit-0.0.1-SNAPSHOT.jar --spring.profiles.active=prod,secret > ../../../log.txt 2>&1 &
